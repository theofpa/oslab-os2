%% Technological Educational Institute (TEI) of Piraeus
%% School of Engineering, Electronic Computer Systems Department
%% Operating Systems Laboratory, 10 October 2010
%% "Theofilos Papapanagiotou" <theofilos@oslab.teipir.gr>
%% "Michalis Iordanakis" <mdi@oslab.teipir.gr>

\section{Σήματα}

Πολλές φορές παρουσιάζονται αναπάντεχα ή απρόβλεπτα συμβάντα
κατά την εξέλιξη ενός προγράμματος όπως για παράδειγμα μιά
πτώση τάσης, ένα σφάλμα κινητής υποδιαστολής, μια αίτηση
αναστολής λειτουργίας από ένα χρήστη κ.ά. Μόλις το σύστημα
αναγνωρίσει ένα τέτοιο συμβάν, στέλνει στην αντίστοιχη διεργασία
ένα σήμα. Τα σήματα χρησιμοποιούνται στην επικοινωνία μεταξύ
υλικού και διεργασιών, ή μεταξύ διεργασιών.

Με τη μέθοδο χειρισμού σημάτων, δίνεται η δυνατότητα στον
προγραμματιστή να καθορίσει αν ένα σήμα θα αγνοηθεί ή θα τύχει
επεξεργασίας. Τα σήματα ορίζονται στο: {\bf signal.h}

Μερικά από τα σήματα είναι:
\begin{itemize}
\item SIGINT: διακοπή από το πληκτρολόγιο
\item SIGABRT: απόρριψη
\item SIGALRM: το χρονόμετρο συναγερμού έχει εκπνεύσει
\item SIGFPE: εξαίρεση κινητής υποδιαστολής
\item SIGCHLD: διακοπή ή τερματισμός διεργασίας child
\item SIGKILL: τερματισμός
\item SIGPIPE: εγγραφή σε pipe χωρίς αναγνώστη
\item SIGQUIT: έξοδος
\item SIGSEGV: αναφορά διεργασίας σε άκυρη διεύθυνση μνήμης
\item SIGTERM: αίτηση για ομαλή διακοπή διεργασίας
\item SIGSTOP: αναστολή διεργασίας
\item SIGCONT: αφύπνιση διεργασίας
\end{itemize}
 
Για δούμε όλα τα σήματα, χρησιμοποιούμε την εντολή kill -l στο φλοιό:
 
\begin{lstlisting}[language=bash,xleftmargin=0em,frame=single,numbers=none,tabsize=4]
$ kill -l
 1) SIGHUP	 	2) SIGINT	 	3) SIGQUIT		 4) SIGILL		 5) SIGTRAP
 6) SIGABRT	 	7) SIGBUS	 	8) SIGFPE		 9) SIGKILL		10) SIGUSR1
11) SIGSEGV		12) SIGUSR2		13) SIGPIPE		14) SIGALRM		15) SIGTERM
16) SIGSTKFLT	17) SIGCHLD		18) SIGCONT		19) SIGSTOP		20) SIGTSTP
21) SIGTTIN		22) SIGTTOU		23) SIGURG		24) SIGXCPU		25) SIGXFSZ
26) SIGVTALRM	27) SIGPROF		28) SIGWINCH	29) SIGIO		30) SIGPWR
31) SIGSYS		34) SIGRTMIN	35) SIGRTMIN+1	36) SIGRTMIN+2	37) SIGRTMIN+3
38) SIGRTMIN+4	39) SIGRTMIN+5	40) SIGRTMIN+6	41) SIGRTMIN+7	42) SIGRTMIN+8
43) SIGRTMIN+9	44) SIGRTMIN+10	45) SIGRTMIN+11	46) SIGRTMIN+12	47) SIGRTMIN+13
48) SIGRTMIN+14	49) SIGRTMIN+15	50) SIGRTMAX-14	51) SIGRTMAX-13	52) SIGRTMAX-12
53) SIGRTMAX-11	54) SIGRTMAX-10	55) SIGRTMAX-9	56) SIGRTMAX-8	57) SIGRTMAX-7
58) SIGRTMAX-6	59) SIGRTMAX-5	60) SIGRTMAX-4	61) SIGRTMAX-3	62) SIGRTMAX-2
63) SIGRTMAX-1	64) SIGRTMAX
\end{lstlisting}

\subsection{Κλήση συστήματος signal()}

Η αντίδραση μιας διεργασίας σε κάποιο από τα προηγούμενα σήματα
ορίζεται με την συνάρτηση signal(), η οποία σε περίπτωση επιτυχίας
επιστρέφει τον προηγούμενο διαχειριστή σήματος ενώ σε περίπτωση
αποτυχίας επιστρέφει -1.

Η συνάρτηση έχει την μορφή:

\begin{verbatim}
void (*signal(int sig, void(*func)(int)));
\end{verbatim}

Στο πρώτο όρισμα sig της συνάρτησης, προσδιορίζεται το σήμα που
θα ληφθεί ή θα αγνοηθεί. Πρέπει να σημειωθεί πως τα σήματα
SIGKILL και SIGSTOP δεν είναι δυνατόν να αναπρογραμματιστούν,
να αλλάξει δηλαδή ο διαχειριστής τους, αλλά ούτε και να αγνοη-
θούν.

Κάποιες από τις τιμές που μπορεί να πάρει το δεύτερο όρισμα func
είναι η SIG\_ING (για παράβλεψη ή απόρριψη του καθορισμένου
σήματος), η SIG\_DFL (για χρήση του προκαθορισμένου διαχειριστή
σήματος του πυρήνα) ή η διεύθυνση μιας συνάρτησης, που ορίζεται
από τον χρήστη και εκτελείται ως διαχειριστής του σήματος.
Οι ρυθμίσεις των σημάτων μιας γονικής διεργασίας, κληροδοτούνται
στις διεργασίες-παιδιά της.

Στη συνέχεια θα δούμε ένα παράδειγμα, στο οποίο μια συνάρτηση
καλείται όταν ένα σήμα λαμβάνει χώρα. Παράγεται ένα μήνυμα και
τότε ενεργοποιείται σήμα λόγω του SIGINT (εξ' ορισμού με το
πάτημα Ctrl-C). Η κύρια λειτουργία του παραδείγματος είναι ένας
ατέρμωνας βρόγχος που εμφανίζει ένα μήνυμα, εκτός και αν
προκύψει κάποιο σήμα.

\lstinputlisting[caption=signal1.c]{lecture2/signal1.c}

Αν το εκτελέσουμε και στη συνέχεια πατήσουμε το συνδυασμό
πλήκτρων Ctrl-Z, θα σταλεί το σήμα STOP στο πρόγραμμα και θα το
σταματήσει. Εκτελούμε την εντολή ps -l και παίρνουμε μία έξοδο,
όπως είναι η παρακάτω:
\begin{verbatim}
S     UID    PID PPID     .  . .   CMD
S    1017 13184 13183     .  . .   bash
T    1017 13435 13184     .  . .   signal-1
R    1017 13436 13184     .  . .   ps
\end{verbatim}

Το T σημαίνει ότι η διεργασία δεν εκτελείται. Για την επανεκκίνηση
πληκτρολογούμε την εντολή fg, η οποία στέλνει το σήμα START. Για
να τερματίσουμε τη διεργασία, πληκτρολογούμε το συνδυασμό
πλήκτρων Ctrl-C.

\subsection{Κλήση συστήματος sigaction()}

Προκειμένου να μην υπάρξουν καταστάσεις συναγωνισμού μεταξύ
των σημάτων, είναι δυνατό να τεθεί από το σύστημα ένα φίλτρο
σημάτων, προτού γίνει κλήση της συνάρτησης χειρισμού.

Αυτό μπορεί να γίνει χρησιμοποιώντας την κλήση συστήματος
sigaction(), η οποία βασικά έχει την ίδια λειτουργία με τη signal(),
με τη διαφορά ότι επιτρέπει επιπλέον ελέγχους και χειρισμούς.

Η συνάρτηση έχει την μορφή:

\begin{verbatim}
int sigaction(int sig, const struct sigaction *newact, struct sigaction
*oldact);
\end{verbatim}

Το πρώτο όρισμα sig είναι το σήμα, για το οποίο θέλουμε να
εγκαταστήσουμε έναν νέο χειριστή ή να επιστραφεί ο παλαιός
χειριστής, έτσι ώστε να είναι εφικτή η επανεγκατάστασή του
αργότερα. Με το όρισμα newact που δείχνει σε μια δομή sigaction,
θέτουμε το νέο χειριστή σήματος. Δίνουμε την τιμή NULL αν δεν
θέλουμε να ορίσουμε νέο. Το τρίτο όρισμα oldact δείχνει σε μία
δομή sigaction, όπου αποθηκεύεται η συμπεριφορά που ήταν
προηγουμένως συσχετισμένη με το sig. Αν δεν μας ενδιαφέρει
δίνουμε την τιμή NULL.
Η δομή sigaction περιέχει συνήθως τα παρακάτω πεδία:

\begin{enumerate}
  \item void sa\_handler      /* SIG\_IGN, SIG\_DFL, function */
  \item sigset\_t sa\_mask /* Τα σήματα που θα ανασταλούν,
                          όσο εκτελείται ο χειριστής σήματος */
  \item int sa\_flags         /* επιπλέον επιλογές για τον
                           καθορισμό ενεργειών */
\end{enumerate}

Ακολουθεί ένα πρόγραμμα που περιέχει μια ερώτηση, που δίνει την
επιλογή στο χρήστη να σταματήσει την εκτύπωση τοπικού χρόνου με
κλήση sigaction() για χειρισμό σήματος SIGINT (Ctrl-C).

Περιέχεται μια δομή act, της οποίας χειριστής είναι η συνάρτηση
question, που ρωτάει αν ο χρήστης πρόκειται να συνεχίσει ή όχι.
Περιμένει 5 δευτερόλεπτα για την απάντηση του χρήστη.

\lstinputlisting[caption=signal2.c]{lecture2/signal2.c}

Η εκτέλεση του προγράμματος είχε ως αποτέλεσμα:

\begin{verbatim}
current time is:
Tue Oct 26 14:30:29 EEST 2010
current time is:
Tue Oct 26 14:30:30 EEST 2010
current time is:
Tue Oct 26 14:30:31 EEST 2010
current time is:
Tue Oct 26 14:30:32 EEST 2010
[1]+  Stopped                 ./signal2
\end{verbatim}

Η sigmeptyset() διαγράφει όλα τα υπάρχοντα σήματα από το λίστα
σημάτων, στην οποία δείχνει το όρισμά της. Σε επιτυχία επιστρέφει 0
και σε λάθος -1.

\subsection{Κλήση συστήματος kill()}
Μια διεργασία μπορεί να στείλει ένα σήμα σε μια άλλη διεργασία,
χρησιμοποιώντας την κλήση συστήματος kill(). Όταν η αποστέλλου-
σα διεργασία ανήκει στον διαχειριστή του συστήματος ή όταν έχει
τον ίδιο ιδιοκτήτη με την διεργασία που παραλαμβάνει το σήμα, τότε
είναι επιτυχής και επιστρέφει 0, ενώ σε περίπτωση αποτυχίας
επιστρέφει -1.

Η συνάρτηση έχει την μορφή:

\begin{verbatim}
int kill(pid_t pid, int sig);
\end{verbatim}

Η kill() στέλνει το σήμα με τιμή sig στη διεργασία με κωδικό pid. Η
kill() επιτυγχάνει και το σήμα στέλνεται, αρκεί η διεργασία
αποστολής και η διεργασία λήψης έχουν τον ίδιο ιδιοκτήτη ή η
διεργασία αποστολής να ανήκει σε έναν υπερχρήστη.

Υπάρχουν ορισμένες παραλλαγές στον τρόπο με τον οποίο εργάζεται
η kill():
\begin{enumerate}
  \item Αν pid == 0, το σήμα στέλνεται σε όλες τις διεργασίες της
   ομάδας της διεργασίας αποστολής.
  \item Αν pid == -1 και ο αποστολέας ανήκει σε έναν υπερχρήστη, το
   σήμα στένεται σε όλες τις διεργασίες, περιλαμβανομένης και της
   διεργασίας αποστολής.
  \item Αν pid == -1 και ο αποστολέας δεν είναι ένας υπερχρήστης, το
   σήμα στέλνεται σε όλες τις διεργασίες που ανήκουν στον
   αποστολέα εκτός της διεργασίας της αποστολής.
  \item Αν pid είναι αρνητικό και όχι -1, το σήμα στέλνεται σε όλες τις
   διεργασίες μέσα στην ομάδα της διεργασίας.
\end{enumerate}
Στη συνέχεια παρουσιάζεται ένα πρόγραμμα στο οποίο μια διεργασία
δημιουργεί δύο διεργασίες παιδιά. Κάθε διεργασία-παιδί εμφανίζει
επαναληπτικά μήνυμα, με το οποίο κάνει αισθητή την υπαρξή της. Η
γονική διεργασία με χρήση της kill(), αναστέλει τη λειτουργία της
πρώτης διεργασίας-παιδί, στη συνέχεια την επαναλειτουργεί και στο
τέλος τερματίζει και τις δύο διεργασίες-παιδιά.

\lstinputlisting[caption=signal3.c]{lecture2/signal3.c}

Η εκτέλεση του προγράμματος είχε ως αποτέλεσμα:

\begin{verbatim}
First child-process
Second child-process
First child-process
Second child-process
First child-process
Second child-process
Second child-process
First child-process
Second child-process
First child-process
Second child-process
\end{verbatim}

\subsection{Η συνάρτηση pause()}
Η pause() αναστέλλει μια διεργασία μέχρι να ληφθεί ένα σήμα.

\begin{verbatim}
#include <unistd.h>
int pause(void);
\end{verbatim}

\subsection{Η συνάρτηση alarm()}
Ένας απλός τρόπος που παρουσιάζει ένα σήμα σε δράση, μπορεί να
υλοποιηθεί με μια διεργασία που δέχεται ένα σήμα συναγερμού
SIGALARM, χρησιμοποιώντας την alarm(). Ο προεπιλεγμένος
χειριστής του σήματος, εμφανίζει το μήνυμα ``Alarm clock'' και
τερματίζει τη διεργασία.

\begin{verbatim}
#include <unistd.h>
int alarm(int count);
\end{verbatim}

Ο πυρήνας λόγω της alarm() στέλνει το σήμα SIGALRM στην
καλούσα διεργασία μετά από count αριθμό δευτερολέπτων. Σε
περίπτωση που υπάρχει ήδη χρονοπρογραμματισμένος κάποιος
συναγερμός, τότε αντικαθίσταται ενώ αν η count είναι ίση με 0,
ακυρώνονται οι τυχόν εκκρεμείς αιτήσεις συναγερμού. Η επιστρε-
φόμενη τιμή της εκφράζει τον αριθμό των δευτερολέπτων που
απομένουν, μέχρι την αποστολή του σήματος συναγερμού.

Στο παράδειγμα που ακολουθεί, δίνεται στο χρήστη χρόνος 15 sec
να πληκτρολογήσει το όνομά του:

\lstinputlisting[caption=signal4.c]{lecture2/signal4.c}

Στο επόμενο παράδειγμα υλοποίησης συναγερμού, μια διεργασία-
παιδί στέλνει σήμα συναγερμού στη γονική της διεργασία. Η γονική
διεργασία λαμβάνει το σήμα και εμφανίζει την τρέχουσα ώρα.

\lstinputlisting[caption=signal5.c]{lecture2/signal5.c}

Η εκτέλεση του προγράμματος είχε ως αποτέλεσμα:

\begin{verbatim}
Alarm
current time is:
Tue Oct 26 14:49:45 EEST 2010
\end{verbatim}

Ο προγραμματισμός με σήματα χρειάζεται προσοχή για να
αποφύγουμε την περίπτωση λάθους. Διαφορετικές εκδόσεις
Linux/Unix υιοθετούν διαφορετικές συμβάσεις για τον χειρισμό
σημάτων και συνήθως παρέχουν επιπλέον λειτουργίες (με την μορφή
ειδικών επιλογών) για τον χειρισμό σημάτων.

\subsection{Ασκήσεις}

\subsubsection{Ασκηση 1}
Να γραφεί πρόγραμμα σε C, το οποίο τερματίζει τον φλοιό.

\subsubsection{Ασκηση 2}
Να γραφεί πρόγραμμα σε C, το οποίο σαν διεργασία, όταν δέχεται
ένα σήμα (π.χ. το SIGUSR1) να δημιουργεί ένα αντίγραφο του
εαυτού του και κατόπιν να τερματίζει.
