%% Technological Educational Institute (TEI) of Piraeus
%% School of Engineering, Electronic Computer Systems Department
%% Operating Systems Laboratory, 10 October 2010
%% "Theofilos Papapanagiotou" <theofilos@oslab.teipir.gr>
%% "Michalis Iordanakis" <mdi@oslab.teipir.gr>
%% "Aggelos Karvounis" <akavroun@oslab.teipir.gr>

\section{Διαδιεργασιακή Επικοινωνία}
Οι ανεξάρτητες διεργασίες (independent processes) δεν επηρεάζουν
ούτε επηρεάζονται (άμεσα) από την εκτέλεση άλλων διεργασιών.
Αντίθετα, οι συνεργαζόμενες διεργασίες (cooperating processes),
δηλαδή οι διεργασίες που σχετίζονται μεταξύ τους και συνεργάζονται
για τη διεκπεραίωση μιας εργασίας, πρέπει να επικοινωνούν και να
συγχρονίζουν τις ενέργειές τους. Αυτή η επικοινωνία καλείται
διαδιεργασιακή επικοινωνία (InterProcess Communication - IPC).
Σαν ένα πρώτο παράδειγμα, μπορούμε να αναφέρουμε την
περίπτωση μιας διοχέτευσης κελύφους (shell pipeline), όπου η
έξοδος μιας διεργασίας αποτελεί είσοδο για μια δεύτερη διεργασία, η
έξοδος της οποίας μπορεί να αποτελεί είσοδο για μια τρίτη κ.ο.κ. Οι
βασικοί λόγοι που οδηγούν στη δημιουργία συνεργαζόμενων
διεργασιών είναι η διαχείριση κοινής πληροφορίας, η επιτάχυνση των
υπολογισμών και ο διαχωρισμός του κώδικα σε ξεχωριστά τμήματα.
Οι συνεργαζόμενες διεργασίες επικοινωνούν μεταξύ τους με:

\begin{itemize}
\item σήματα
\item ανταλλαγή μηνυμάτων
\item κοινή μνήμη
\item υποδοχές
\item αρχεία
\item σωλήνες
\end{itemize}

Ο σωλήνας είναι ειδικός τύπος «αρχείου» FIFO που χρησιμοποιείται
την σειριακή μεταφορά δεδομένων μεταξύ δύο διεργασιών, προς μια
κατεύθυνση. Υπάρχει δυνατότητα δημιουργίας ενός (μόνιμου)
σωλήνα με ένα συγκεκριμένο όνομα (με χρήση της mknod), όπου
το όνομα μπορεί να χρησιμοποιηθεί για να αποκτηθεί πρόσβαση
(ανάγνωσης ή γραψίματος) στον σωλήνα, όπως ακριβώς με ένα
αρχείο, καθώς επίσης και (προσωρινού) σωλήνα χωρίς όνομα (με
χρήση της pipe), όπου επιστρέφονται 2 αριθμοί δομών πρόσβασης
(για ανάγνωση και γράψιμο).

\subsection{Κλήση συστήματος pipe()}
Ένας σωλήνας χωρίς όνομα μπορεί να χρησιμοποιηθεί μόνο από
διεργασίες που διαθέτουν και την αντίστοιχη δομή πρόσβασης
(ανάγνωσης ή γραψίματος). Απόγονοι της διεργασίας που
δημιούργησε το σωλήνα, συμπεριλαμβανομένης και της ίδιας της
διεργασίας-δημιουργού, μπορούν να επικοινωνήσουν μέσω του
σωλήνα, που αποτελεί ουσιαστικά ένα είδος ενδιάμεσης μνήμης,
γράφοντας με τη write και διαβάζοντας με τη read από το κατάλληλο
άκρο.

Χρησιμοποιείται σχεδόν αποκλειστικά για την επικοινωνία μεταξύ
γονιού-παιδιού ή μεταξύ των παιδιών ενός γονιού δηλαδή για
διεργασίες που έχουν κοινό πρόγονο ο οποίος έχει δημιουργήσει το
σωλήνα. Υποστηρίζει επικοινωνία προς μια κατεύθυνση μόνο, όπου η
μια διεργασία γράφει στο άκρο γραψίματος του σωλήνα και η άλλη
διαβάζει από το άκρο διαβάσματος. Η συνάρτηση έχει την παρακάτω
μορφή:

\begin{verbatim}
int pipe(int fd[]);
\end{verbatim}

Η κλήση pipe() λαμβάνει ως παράμετρο έναν πίνακα fd δύο
ακεραίων και θέτει τις τιμές τους σε περιγραφείς δύο άκρων μιας
σωλήνωσης. Ο περιγραφέας fd[0] προσδιορίζει το άκρο της
σωλήνωσης από το οποίο μπορούμε να διαβάσουμε ενώ ο
περιγραφέας fd[1] προσδιορίζει το άκρο της σωλήνωσης στο οποίο
γράφουμε. Τα στοιχεία που γράφονται στο ένα άκρο της σωλήνωσης
μπορούν να διαβαστούν από το άλλο.

Τα μη χρησιμοποιούμενα άκρα πρέπει να ελευθερώνονται με την
close(). Η pipe επιστρέφει 0 σε επιτυχία ή -1 σε αποτυχία.
Ας δούμε ένα απλό παράδειγμα χρήσης της pipe(), στο οποίο
γράφεται στο άκρο γραψίματος του σωλήνα ένα μήνυμα, το οποίο
κατόπιν το διαβάζει από το άκρο διαβάσματος του σωλήνα και τελικά
το γράφει στη stdout δηλαδή την οθόνη:

\lstinputlisting[label=pipe1.c, caption=pipe1.c]{lecture2/pipe1.c}

Η εκτέλεση του προγράμματος θα μας δώσει:

\begin{verbatim}
This is a pipe message
\end{verbatim}

Στο προηγούμενο παράδειγμα η δημιουργία και η χρήση
του σωλήνα υποστηρίζεται εξ' ολοκλήρου σε μία διεργασία, κι έτσι
δε μας δίνεται η δυνατότητα να κατανοήσουμε τη διαδιεργασιακή
επικοινωνία που μπορεί να υλοποιηθεί με τους σωλήνες.
Ας δούμε στη συνέχεια, ένα παράδειγμα, στο οποίο με χρήση της
pipe(), μια διεργασία παιδί στέλνει ένα μήνυμα στη γονική διεργασία
της, η οποία το εμφανίζει.

\lstinputlisting[label=pipe2.c, caption=pipe2.c]{lecture2/pipe2.c}

Η εκτέλεση του προγράμματος θα μας δώσει:

\begin{verbatim}
This is an IPC message, with pipe
\end{verbatim}

Στο επόμενο παράδειγμα, υλοποιείται πρόγραμμα σύνδεσης της
εξόδου της γονικής-διεργασίας με την είσοδο της διεργασίας-παιδιού.

Συγκεκριμένα, το μήνυμα που γράφει η γονική-διεργασία στην
stdout, γράφεται στο άκρο γραψίματος του σωλήνα, επειδή έχει
ταυτιστεί μ’ αυτό, ενώ η διεργασία-παιδί εμφανίζει ό,τι διαβάζει από
την stdin που έχει ταυτιστεί με το άκρο διαβάσματος του σωλήνα και
τελικά το εμφανίζει.

\lstinputlisting[label=pipe3.c, caption=pipe3.c]{lecture2/pipe3.c}

Η εκτέλεση του προγράμματος θα δώσει:

\begin{verbatim}
I am the child...	
From parent: Hello
From parent: my
From parent: child
\end{verbatim}

Ας επεκτείνουμε το προηγούμενο παράδειγμα, υλοποιώντας
πρόγραμμα σωλήνωσης μεταξύ γονικής-διεργασίας και διεργασίας-
παιδιού, έτσι ώστε κάθε μια από τις διεργασίες να εκτελεί εντολή της
οικογένειας exec και το αποτέλεσμα της γονικής-διεργασίας θα
χρησιμοποιείται από τη διεργασία-παιδί.

\lstinputlisting[label=pipe4.c, caption=pipe4.c]{lecture2/pipe4.c}

Η εκτέλεση του προγράμματος θα δώσει τρεις αριθμούς π.χ.

\begin{verbatim}
10    83    585
\end{verbatim}

που εκφράζει το αποτέλεσμα της wc που εκτέλεσε η διεργασία-παιδί,
πάνω στο αποτέλεσμα της ls, που έλαβε από τη γονική διεργασία
μέσω του σωλήνα.

\subsection{Κλήση συστήματος mkfifo()}

με το σωλήνα που χρησιμοποιήσαμε στα προηγούμενα παραδείγμα-
τα, μπορούν να επικοινωνούν μόνο ``συγγενικές'' διεργασίες. με τη
χρήση των FIFO μπορούν να ανταλλάξουν δεδομένα και διεργασίες
που δεν έχουν συγγενική σχέση μεταξύ τους. Η κλήση συστήματος
mkfifo() δημιουργεί έναν επώνυμο σωλήνα που έχει τις ίδιες
ιδιότητες με έναν ανώνυμο σωλήνα (half-duplex, fist in - first out),
με τη διαφορά ότι στην ουσία πρόκειται για ένα αρχείο στο δίσκο. Η
σύνταξή της είναι:

\begin{verbatim}
#include <sys/types>
#include <sys/stat.h>
int mkfifo(const char *path, mode_t mode);
\end{verbatim}

Σε επιτυχία επιστρέφει 0 και σε αποτυχία -1 ενημερώνοντας
κατάλληλα την errno. Η πρώτη παράμετρος είναι το όνομα του
αρχείου που θα δημιουργηθεί και η δεύτερη παράμετρος καθορίζει τα
δικαιώματα πρόσβασης. Το επόμενο παράδειγμα δείχνει τον τρόπο
δημιουργίας επώνυμου σωλήνα με γράψιμο και διάβασμα από την
ίδια διεργασία:

\lstinputlisting[label=pipe5.c, caption=pipe5.c]{lecture2/pipe5.c}

Στο επόμενο παράδειγμα η ανταλλαγή δεδομένων γίνεται από δύο
ξεχωριστές διεργασίες. Το πρόγραμμα receiver δημιουργεί έναν
επώνυμο σωλήνα και διαβάζει συνεχώς απ’ αυτόν μέχρι να παρα-
λάβει τη λέξη ``exit''.

\lstinputlisting[label=pipe6.c, caption=pipe6.c]{lecture2/pipe6.c}

Το πρόγραμμα sender καλείται με τουλάχιστον ένα όρισμα από τη
γραμμή εντολών του Λ.Σ. και ανοίγει το σωλήνα με την επιλογή
O\_RDWR $|$ O\_NONBLOCK (γιατί;). Στη συνέχεια γράφει κάθε
παράμετρο στο fifo.

\lstinputlisting[label=pipe7.c, caption=pipe7.c]{lecture2/pipe7.c}

\subsection{Ασκήσεις}
\subsubsection*{Ασκηση 1}
Να γραφούν δύο προγράμματα σε C, τα οποία με χρήση pipes θα
επικοινωνούν μεταξύ τους. Το πρόγραμμα prog1 θα δημιουργεί μία
νέα διεργασία-παιδί, που θα αντικαθίσταται από το πρόγραμμα
prog2. Το prog2 θα διαβάζει λέξεις από το πληκτρολόγιο και θα τις
στέλνει στη διεργασία-πατέρα, η οποία θα εμφανίζει τη λέξη στην
οθόνη. Και τα δύο προγράμματα θα τερματίζονται όταν ο χρήστης θα
πληκτρολογήσει τη λέξη END.
\subsubsection*{Ασκηση 2}
Γράψτε ένα πρόγραμμα σε C, το οποίο υλοποιεί μια σωλήνωση,
δηλαδή συνδέει την προκαθορισμένη έξοδο μιας εντολής στην
προκαθορισμένη είσοδο μιας άλλης.
\subsubsection*{Ασκηση 3}
Να γραφούν δύο προγράμματα σε C, τα οποία με χρήση pipes θα
επικοινωνούν μεταξύ τους. Το πρώτο πρόγραμμα mainprog θα
δημιουργεί μία νέα διεργασία-παιδί, που θα καλεί το δεύτερο
πρόγραμμα readfile. Το πρόγραμμα readfile θα ανοίγει το αρχείο
κειμένου oslab.dat, θα το διαβάζει χαρακτήρα-χαρακτήρα και θα
στέλνει το χαρακτήρα που διάβασε στο mainprog. Η διεργασία-
πατέρας θα εμφανίζει στη οθόνη το μέγεθος του αρχείου κειμένου,
καθώς και το πλήθος των γραμμών του και θα τερματίζεται.
\subsubsection*{Ασκηση 4}
Να γραφούν δύο προγράμματα σε C, τα οποία με χρήση fifo' s θα
έχουν αμφίδρομη επικοινωνία.
